{% extends "shopping/base.html" %}
{% load static %}

{% block content %}
	<section class="section-content padding-y bg">
		<div class="container">
            <h4 class="text-center mb-10">Review Your Order and Make Payment</h4>
			<div class="row">
				<main class="col-md-8">
					<article class="card mb-4">
                        <div class="card-body">
                            <h4 class="card-title mb-4">Billing Address</h4>
                            <div class="card-body">
                                <p class="card-text mb-0">{{ order.full_name }}</p>
                                <p class="card-text mb-0">{{ order.full_address }}</p>
                                <p class="card-text mb-0">{{ order.city }}, {{ order.state }}, {{ order.postal_code }}</p>
                                <p class="card-text mb-0">{{ order.house_number }}, {{ order.building_name }}</p>
                                <p class="card-text mb-0">{{ order.address_line_1 }}</p>
                                {% if order.address_line_2 %}
                                    <p class="card-text mb-0">{{ order.address_line_2 }}</p>
                                {% endif %}
                                <p class="card-text mb-0">{{ order.email }}</p>
                                <p class="card-text mb-0">{{ order.phone }}</p>
                                {% if order.order_note %}
                                    <b>Order Note: </b> {{ order.order_note }}
                                {% endif %}
                            </div>	
                        </div> <!-- card-body.// -->
					</article> <!-- card.// -->

					<article class="accordion" id="accordion_pay">
						<div class="card">
							<header class="card-header">
									<h6 class="form-check-label"> 
										Paypal 
									</h6>
								</label>
							</header>
						</div> <!-- card.// -->
					</article> 
                    <br>
                    <article class="card mb-4">
						<div class="card-body">
							<h4 class="card-title mb-4">Review cart</h4>
							<table class="table">
								<thead class="small text-uppercase">
									<tr>
										<th scope="col">Product</th>
										<th scope="col">Quantity</th>
										<th scope="col">Price</th>
										<th scope="col" class="text-right" width="200"> </th>
									</tr>
								</thead>
								<tbody>
									{% for cart_item in cart_items %}
										<tr>
											<td>
												<figure class="itemside align-items-center">
													<div class="aside"><img src="{{ cart_item.product.images.url }}" class="img-sm"></div>
													<figcaption class="info">
														<a href="{{ cart_item.product.get_url }}" class="title text-dark">{{ cart_item.product.product_name }}</a>
														<p class="text-muted small">
															{% if cart_item.variations.all %}
																{% for item in cart_item.variations.all %}
																	{{ item.variation_category | capfirst }} : {{ item.variation_value | capfirst }}
																	<br>
																{% endfor %}
															{% endif %}
														</p>
														<br>
													</figcaption>
												</figure>
											</td>
											<td>{{ cart_item.quantity }}</td>
											<td>{{ cart_item.product.price }}</td>
											<td></td>
										</tr> 		
									{% endfor %}
								</tbody>
							</table>
						</div> <!-- card-body.// -->
					</article> <!-- card.// -->
					<!-- accordion end.// -->
				</main> <!-- col.// -->

				<aside class="col-md-4">
					<div class="card">
						<div class="card-body">
							<dl class="dlist-align">
								<dt>Total price:</dt>
								<dd class="text-right">$ {{ total }}</dd>
							</dl>
							<dl class="dlist-align">
								<dt>Tax:</dt>
								<dd class="text-right">$ {{ tax }}</dd>
							</dl>
							<dl class="dlist-align">
								<dt>Grand Total:</dt>
								<dd class="text-right text-dark b"><strong>$ {{ grand_total }}</strong></dd>
							</dl>
							<hr>
							<div id="paypal-button-container"></div>	
						</div> <!-- card-body.// -->
					</div> <!-- card.// -->
				</aside> <!-- col.// -->
				</form>
			</div> <!-- row.// -->
		</div> <!-- container .//  -->
	</section>
<!-- ========================= SECTION CONTENT END// ========================= -->

<script>

	function getCookie(name) {
		var cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			var cookies = document.cookie.split(';');
			for (var i = 0; i < cookies.length; i++) {
				var cookie = cookies[i].trim();
				// Does this cookie string begin with the name we want?
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}

	var url = "{% url 'payments' %}";
	var csrftoken = getCookie('csrftoken');
	var orderID = '{{ order.order_number }}';
	var payment_method = 'PayPal';
	var redirect_url = "{% url 'order_complete' %}";
	
	// Render the PayPal button into #paypal-button-container
	paypal.Buttons({

		style: {
			shape: 'rect',
			color: 'blue',
			layout: 'vertical',
			label: 'pay',
			height: 40
		},

		// Call your server to set up the transaction
		createOrder: function(data, actions) {
			return actions.order.create({
				purchase_units: [{
					amount: {
						value: '{{ grand_total }}'
					}
				}]
			});
		},

		// Call your server to finalize the transaction
		onApprove: function(data, actions) {
			return actions.order.capture().then(function(details) {
				console.log(details);
				sendData();
				function sendData(){
					fetch(url, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'X-CSRFToken': csrftoken,
						},
						body: JSON.stringify({
							orderID : orderID,
							transID : details.id,
							payment_method : payment_method,
							status : details.status,
					}),
				})
				.then((response) => response.json())
				.then((data) => {
					window.location.href = redirect_url + '?order_number=' + data.order_number + '&payment_id=' + data.transID;
				});
			}
		});
	}
	}).render('#paypal-button-container');
</script>

{% endblock %}